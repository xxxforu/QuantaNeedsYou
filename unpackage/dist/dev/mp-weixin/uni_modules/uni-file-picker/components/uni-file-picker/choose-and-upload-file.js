"use strict";const d=require("../../../../common/vendor.js"),g="chooseAndUploadFile:ok",p="chooseAndUploadFile:fail";function F(e){const{count:s,sizeType:n=["original","compressed"],sourceType:i,extension:l}=e;return new Promise((r,c)=>{d.index.chooseMedia({count:s,sizeType:n,sourceType:i,mediaType:["image"],extension:l,success(a){a.tempFiles.forEach(u=>{u.path=u.tempFilePath}),r(m(a,"image"))},fail(a){c({errMsg:a.errMsg.replace("chooseImage:fail",p)})}})})}function y(e){const{count:s,camera:n,compressed:i,maxDuration:l,sourceType:r,extension:c}=e;return new Promise((a,u)=>{d.index.chooseMedia({count:s,compressed:i,maxDuration:l,sourceType:r,extension:c,mediaType:["video"],success(t){const{tempFiles:h}=t;a(m({errMsg:"chooseVideo:ok",tempFiles:h.map(o=>({name:o.name||"",path:o.tempFilePath,thumbTempFilePath:o.thumbTempFilePath,size:o.size,type:t.tempFile&&t.tempFile.type||"",width:o.width,height:o.height,duration:o.duration,fileType:"video",cloudPath:""}))},"video"))},fail(t){u({errMsg:t.errMsg.replace("chooseVideo:fail",p)})}})})}function M(e){const{count:s,extension:n}=e;return new Promise((i,l)=>{let r=d.index.chooseFile;if(typeof d.wx$1<"u"&&typeof d.wx$1.chooseMessageFile=="function"&&(r=d.wx$1.chooseMessageFile),typeof r!="function")return l({errMsg:p+" 请指定 type 类型，该平台仅支持选择 image 或 video。"});r({type:"all",count:s,extension:n,success(c){i(m(c))},fail(c){l({errMsg:c.errMsg.replace("chooseFile:fail",p)})}})})}function m(e,s){return e.tempFiles.forEach((n,i)=>{n.name||(n.name=n.path.substring(n.path.lastIndexOf("/")+1)),s&&(n.fileType=s),n.cloudPath=Date.now()+"_"+i+n.name.substring(n.name.lastIndexOf("."))}),e.tempFilePaths||(e.tempFilePaths=e.tempFiles.map(n=>n.path)),e}function x(e,s=5,n){e=JSON.parse(JSON.stringify(e));const i=e.length;let l=0,r=this;return new Promise(c=>{for(;l<s;)a();function a(){let u=l++;if(u>=i){!e.find(o=>!o.url&&!o.errMsg)&&c(e);return}const t=e[u],h=r.files.findIndex(o=>o.uuid===t.uuid);t.url="",delete t.errMsg,d.Vs.uploadFile({filePath:t.path,cloudPath:t.cloudPath,fileType:t.fileType,onUploadProgress:o=>{o.index=h,n&&n(o)}}).then(o=>{t.url=o.fileID,t.index=h,u<i&&a()}).catch(o=>{t.errMsg=o.errMsg||o.message,t.index=h,u<i&&a()})}})}function f(e,{onChooseFile:s,onUploadProgress:n}){return e.then(i=>{if(s){const l=s(i);if(typeof l<"u")return Promise.resolve(l).then(r=>typeof r>"u"?i:r)}return i}).then(i=>i===!1?{errMsg:g,tempFilePaths:[],tempFiles:[]}:i)}function P(e={type:"all"}){return e.type==="image"?f(F(e),e):e.type==="video"?f(y(e),e):f(M(e),e)}exports.chooseAndUploadFile=P;exports.uploadCloudFiles=x;
